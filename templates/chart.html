<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canyon Lake 30-Day Water Level History | Texas Lake Trends</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="View 30-day historical water level trends for Canyon Lake, Texas. Interactive charts showing lake elevation, river flow data, and historical patterns from USGS monitoring. Track daily changes, seasonal trends, and Guadalupe River inflow rates. Compare current levels to historical averages.">
    <meta name="keywords" content="Canyon Lake history, Canyon Lake historical data, Texas lake trends, water level chart, historical data, Guadalupe River flow, Guadalupe River history, Guadalupe River Texas, Guadalupe River trends, lake statistics, water trends, Canyon Lake graph, lake level history, 30 day chart, water level trends, lake monitoring history, historical lake levels, Canyon Lake statistics, river flow chart, lake data visualization, Canyon Lake patterns, water resource trends, Texas drought history, lake elevation chart, San Antonio area water levels, San Antonio lakes history, New Braunfels water data, Hill Country lake trends, Guadalupe River flow data, river inflow chart, Texas water statistics">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large">
    <meta name="googlebot" content="index, follow">
    <link rel="canonical" href="https://isthelakefull.com/chart">

    <!-- Additional SEO Tags -->
    <meta name="language" content="English">
    <meta name="revisit-after" content="1 day">
    <meta name="category" content="data visualization, lake monitoring, water resources">
    <meta name="classification" content="Historical Data, Water Level Charts">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://isthelakefull.com/chart">
    <meta property="og:title" content="Canyon Lake 30-Day History | Water Level Trends">
    <meta property="og:description" content="View 30-day historical water level trends and river flow data for Canyon Lake, Texas with interactive charts.">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://isthelakefull.com/chart">
    <meta property="twitter:title" content="Canyon Lake 30-Day History | Water Level Trends">
    <meta property="twitter:description" content="View 30-day historical water level trends and river flow data for Canyon Lake, Texas with interactive charts.">

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
    <div class="chart-container">
        <h1 style="font-size: 2em; margin-bottom: 20px;">Canyon Lake 30-Day History</h1>
        
        <div id="loading" class="loading">Loading historical data...</div>
        
        <div id="content" style="display: none;">
            <div class="chart-wrapper">
                <canvas id="chart"></canvas>
            </div>
            
            <div class="stats" style="margin-top: 30px;">
                <div class="stat-box">
                    <div class="stat-label">30-Day High</div>
                    <div class="stat-value" id="high">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">30-Day Low</div>
                    <div class="stat-value" id="low">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">30-Day Average</div>
                    <div class="stat-value" id="average">-</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <a href="/" class="nav-link">Back to Current Status</a>
                {% if show_analytics %}
                <a href="/analytics" class="nav-link" style="margin-left: 10px;">View Site Analytics</a>
                {% endif %}
            </div>
        </div>
        
        <div id="error" class="error" style="display: none;">
            Unable to load historical data. Please try again later.
        </div>
    </div>
    
    <script>
        let chart = null;
        
        async function fetchHistoricalData() {
            try {
                // Fetch both lake data and 12-hour flow data
                const [lakeResponse, flowResponse] = await Promise.all([
                    fetch('/api/history'),
                    fetch('/api/flow-12hr')
                ]);
                
                const lakeData = await lakeResponse.json();
                const flowData = await flowResponse.json();
                
                if (lakeData.status === 'success' && flowData.status === 'success') {
                    displayChart(lakeData.data, flowData.data);
                } else {
                    showError();
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showError();
            }
        }
        
        function displayChart(lakeData, flowData) {
            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            
            // Calculate statistics
            const percentages = lakeData.map(d => d.percentage_full);
            const elevations = lakeData.map(d => d.elevation);
            const high = Math.max(...percentages);
            const low = Math.min(...percentages);
            const average = percentages.reduce((a, b) => a + b, 0) / percentages.length;
            
            document.getElementById('high').textContent = high.toFixed(1) + '%';
            document.getElementById('low').textContent = low.toFixed(1) + '%';
            document.getElementById('average').textContent = average.toFixed(1) + '%';
            
            // Prepare chart data
            const chartData = {
                labels: flowData.map(d => new Date(d.timestamp)),
                datasets: [{
                    label: 'Lake Level (%)',
                    data: lakeData.map(d => ({
                        x: new Date(d.date),
                        y: d.percentage_full
                    })),
                    borderColor: '#5DADE2',
                    backgroundColor: 'rgba(93, 173, 226, 0.1)',
                    tension: 0.1,
                    fill: true,
                    yAxisID: 'y',
                    spanGaps: true
                }, {
                    label: 'River Flow - 12hr avg (cfs)',
                    data: flowData.map(d => ({
                        x: new Date(d.timestamp),
                        y: d.flow
                    })),
                    borderColor: '#48C9B0',
                    backgroundColor: 'rgba(72, 201, 176, 0.1)',
                    tension: 0.1,
                    fill: true,
                    yAxisID: 'y1',
                    spanGaps: true
                }]
            };
            
            // Chart configuration
            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: 10
                    },
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const datasetIndex = context.datasetIndex;
                                    
                                    if (datasetIndex === 0) {
                                        const percentage = context.parsed.y.toFixed(1);
                                        // Find matching elevation
                                        const lakeItem = lakeData.find(d => 
                                            Math.abs(new Date(d.date) - new Date(context.parsed.x)) < 86400000
                                        );
                                        if (lakeItem) {
                                            return [
                                                `Level: ${percentage}%`,
                                                `Elevation: ${lakeItem.elevation.toFixed(2)} ft`
                                            ];
                                        }
                                        return `Level: ${percentage}%`;
                                    } else {
                                        const flow = context.parsed.y;
                                        const flowItem = flowData.find(d => d.timestamp === context.raw.x.toISOString());
                                        const period = flowItem ? flowItem.period : '';
                                        return [
                                            `Flow: ${flow.toLocaleString()} cfs`,
                                            `Period: ${period}`
                                        ];
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM d'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Lake Level (%)'
                            },
                            min: 0,
                            max: 110,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'River Flow (cfs)'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' cfs';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            };
            
            // Add reference lines
            config.options.plugins.annotation = {
                annotations: {
                    line1: {
                        type: 'line',
                        yMin: 75,
                        yMax: 75,
                        borderColor: '#ff7043',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        label: {
                            content: 'Low Threshold (75%)',
                            enabled: true,
                            position: 'start'
                        }
                    },
                    line2: {
                        type: 'line',
                        yMin: 98,
                        yMax: 98,
                        borderColor: '#66bb6a',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        label: {
                            content: 'Full (98%)',
                            enabled: true,
                            position: 'start'
                        }
                    }
                }
            };
            
            // Create chart
            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(ctx, config);
        }
        
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
        
        // Fetch data on load
        fetchHistoricalData();
    </script>
</body>
</html>